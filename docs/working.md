# Working Log

## 2026-02-16

- 首页标题区改为“模型轮播 + AI相面”并右对齐，三枚 tab 保持在右上角；底部右侧只显示品牌名，不再显示 `MediaPipe Face Detection` 文案。
- “开始相面”按钮从画面中间移到下边栏上方，下边栏高度提高，摄像头预览区域不再被按钮遮挡。
- 短结果页覆盖层改为近乎全遮罩，避免透出摄像头背景；继续按钮文案改为“按空格键或点击此处继续下一位”。
- 短结果生成后会写入浏览器历史状态，支持“后退回上一位结果、前进回当前流程”。
- 结果页二维码区新增“直接访问链接”，电脑/手机都可直接点开分享页，不必每次扫码。
- 修复了结果页偶发“重复生成多个 share_id、二维码不断变化”的问题，同一份结果只会创建一次分享记录。
- 分享页二层解读改为“优先读缓存”：如果详细解读已准备好就直接展示；没有时再现场生成，用户无感切换。
- `/api/share` 创建后会在后台异步预生成详细解读，缩短后续打开分享页的等待时间。
- 相面学指南在手机端改为 hamburger 菜单：点击“目录”弹出章节抽屉，支持随时跳转，不再依赖顶部下拉框。
- L1 页面改为品字形三卡：上方是更大的“面相特征检测结果”，下方左侧“像素画像”（标题在图下），下方右侧“二维码+详细解读入口”。
- L1 页面视觉层级修正：保留 Year of the Horse 背景图，同时结果卡片改为实体底色，卡片覆盖区域不再透出后景。
- L1 页面展示细节修正：面相特征检测图改为居中显示，结果文本主卡也使用实体背景，滚动区域不会透出后景。
- L1 页面再次细化：保留背景图可见性（仅作为页面底图），并将二维码内层容器也改为实体底色，避免“卡片里仍有半透明”观感。
- L1 渲染修正：面相特征检测卡的“点击查看大图”恢复为图下方文案，并给检测图层增加实体底板，彻底避免背景从图层内部透出。
- 标题模型切换动效从淡入淡出改为翻转式切换（rotate 风格），切换观感更明确。
- L1 透明度进一步修正：将关键卡片背景改为显式实色（不依赖透明度变量），确保面相检测卡与二维码卡不再透出底图。
- L1 结果区外层增加实体底色面板，覆盖卡片之间与周边空隙，避免“单卡不透但整体仍透底”的观感。
- L1 再次加固：最外层可滚动容器也强制实色底并禁用背景图层，按“最蠢但可靠”的方式彻底消除透底。
- 新增 `/api/share` 分段耗时日志（编码、序列化、写库、总耗时及负载体积），便于线上直接定位慢点是否出在 Firestore 写入。
- L1 层级顺序修正：将 Year of the Horse 背景层固定在 `z-0`，结果/相机内容提升到 `z-10`，避免背景图在图片加载后反压到前景造成“先正常后变透明”。
- 新增 share 存储抽象层 `ShareStorage`：路由与邮件订阅流程不再直接依赖 Firebase SDK，统一通过存储接口读写。
- 存储层新增 PostgreSQL 实现 `PostgresShareStorage`，支持与 Firebase 并存切换，环境变量可控制后端类型。
- 新增环境变量约定：`SHARE_STORAGE_BACKEND`（`auto|firebase|postgres`）与 `SHARE_DATABASE_URL`，并更新 `.env.example`（使用占位连接串）。
- 为 Koyeb/Neon 风格连接串增加自动兼容：默认追加 `sslmode=require`，并自动补充 `options=endpoint=<ep-...>` 以避免 SNI/endpoint 报错。
- 新增 backfill 脚本 `scripts/backfill_firebase_to_postgres.py`，可将 Firestore 的 `fortunes` 集合迁移到 Postgres。
- 新增 `tests/test_storage.py` 并补充接口切换测试与 URL 规范化测试；当前全量测试通过（`71 passed, 1 skipped`）。
- backfill 脚本升级为批处理与弱网容错：改用 `list_documents` + 分批处理、单文档重试、批间节流、实时进度日志，并新增 `--batch-size`、`--sleep-between-batches`、`--max-docs` 参数。
- 新增真实 Postgres 存储集成测试 `tests/test_storage_integration_live.py`（默认跳过，仅在 `RUN_INTEGRATION_TESTS=1` 时启用），覆盖 create/get/update/异常分支并做测试数据清理。
- 验证了新集成测试可在显式启用时通过（`RUN_INTEGRATION_TESTS=1 pytest tests/test_storage_integration_live.py`）。
- 深度分析多模型调用超时从 `60s` 提高到 `300s`，并加入可重试错误的指数退避重试（超时/网络错误/429/5xx），减少邮件中仅单模型成功的概率。
- 深度分析重试策略进一步增强：最大尝试 `6` 次，退避改为 `5s -> 10s -> 20s`（上限 20s），并将“空响应”纳入可重试范围。
- Share 页面的 L2（Gemini）详细解读请求增加前端重试：首次失败后等待 `5s` 自动重试 1 次，减少用户手动刷新。

### Future Work

- L1 背景可见性进一步微调：当前方案优先保证结果容器不透底，后续可优化为“容器内完全遮挡、容器外继续可见 Year of the Horse”以兼顾可读性与氛围。
- AI 超时阈值提高（后端 40s、前端 50s），降低冷启动或弱网时直接落入 fallback 的概率。
- 页面右下角新增版本号展示，格式为 `Superlinear Academy, v<build_version>`，便于对照线上版本。
- 邮件品牌标题统一为“AI相面”，邮件内容与产品文案保持一致。

## 2026-02-15

- 印堂判定从三档扩展为四档（过宽/开阔/适中/较窄），边界面相的判断更稳定。
- 首页改为上中下三段结构：顶部导航、中部主内容、底部免责声明；结果出现时直接切换到结果视图，不再半透明叠加。
- 分享页按钮主次重排：主按钮突出“留邮箱获取三模型完整解读”，次按钮“我也要相面”弱化，减少误触。
