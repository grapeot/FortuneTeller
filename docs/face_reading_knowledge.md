# 面相识别与生成 SOP（v2）

本文件用于统一三件事：
1. 面相知识如何结构化落地到 AI 系统；
2. 哪些结论可以由 landmark/测量确定，哪些必须交给视觉模型补充；
3. 简版/详版/邮件三层产物如何共用一套底层事实，保证口径一致。

> 适用范围：`face-annotator.js`、`tools/visualize_face.py`、`ai-fortune.js`、`server/prompts.py`、分享页与订阅后深度报告。

---

## 0. 目标与边界

目标不是“玄学堆词”，而是“可追溯推断”：每条结论都尽量能回溯到 **可见特征 + 测量值 + 交叉验证规则**。

边界：
- 仅用于文化娱乐和自我观察，不用于医疗、招聘、信贷等严肃决策；
- 输出以正向建议为主，不做负面定性标签；
- 不承诺“命运预测准确性”，强调“特征观察 + 行为建议”。

---

## 1. 三层产品形态（对应用户流程）

### L1 现场速览（当前机台页面）
- 模型：`Grok`（简洁快速）
- 字数：约 120-220 字
- 结构：面部观察 2-3 点 + 1 条行动建议 + 1 句马年祝福
- 输入：实时 landmark 测量 + 现场拍照特征
- 目标：3-6 秒内给出可读结果，适合围观场景

### L2 扫码详版（分享页）
- 模型：`Gemini 3 Flash`
- 字数：约 350-600 字
- 结构：五官/三停/重点宫位 + 事业财运 + 关系沟通 + 风险提示（温和）
- 输入：L1 同源事实 + 扩展测量 + 可视化骨架图
- 目标：让用户明显感知“比现场更深入、更有证据链”

### L3 邮件深度版（订阅后）
- 模型：`DeepSeek + Grok + Gemini` 三模型并行
- 字数：每模型 500-800 字，外加 1 段聚合总结
- 结构：模型独立报告 + 共识/分歧对照 + 可执行建议清单
- 输入：统一事实包（landmarks+measurements+image context）
- 目标：形成“多专家会诊”体验，兼顾丰富度和可比性

---

## 2. 结构化观察维度（SOP 核心）

以下为可落地维度，优先级从高到低。

### A. 发际线与上庭
- 观察项：发际线齐整度、杂毛/锯齿感、M 形/美人尖、上庭高度
- 数据来源：
  - landmark 确定：`foreheadTop(10)`、眉峰线、三停比例
  - 视觉补充：真实发际线纹理（landmark 不能可靠覆盖头发边界）
- 判定建议：
  - 可确定：上庭相对比例（使用发际线估计点）
  - 需谨慎：齐整/杂毛类判断必须依赖图像纹理

### B. 田宅宫（眉眼间）
- 观察项：饱满/凹陷、宽窄、褶皱
- 数据来源：眉峰到上眼睑距离、左右对称差、局部阴影纹理
- 规则：
  - 距离阈值用于“宽窄”
  - 饱满与褶皱需要视觉模型参与

### C. 眼睛
- 观察项：黑白比例、内眼角尖圆、上吊/下垂、神采
- 数据来源：眼裂高宽比、眼轴倾角、眼白暴露区（视觉）
- 规则：
  - “眼形几何”可算；“神采/眼神”仅作弱结论

### D. 鼻梁与鼻翼
- 观察项：细长露骨/宽厚、驼峰、鼻翼张力
- 数据来源：鼻梁折线、鼻宽/眼距比、鼻长/脸高比
- 规则：
  - 几何比值可稳定输出
  - “露骨/肉感”需图像纹理做校正

### E. 嘴唇与嘴角
- 观察项：厚薄、覆船（下压）、月牙（上扬）
- 数据来源：唇厚比、嘴角高度差、口宽/眼距比

### F. 下巴与下颌
- 观察项：尖/方/宽、下停承接力
- 数据来源：下颌宽/颧骨宽、下庭占比、下巴曲率

### G. 耳朵
- 观察项：高低、贴脑/招风、耳垂厚薄
- 数据来源：
  - 当前正脸 landmark 对耳部不充分
  - 需额外耳部检测模型或多角度采集
- 当前策略：耳部结论降级为“弱提示”，不得作为主结论支点

---

## 3. 多项定一项：决策规则

采用《麻衣神相》《水镜神相》中“相不独论”的工程化版本：

1) 先找稳定特征：比例、距离、对称性（确定性高）
2) 再看纹理特征：凹陷、褶皱、气色（确定性中）
3) 交叉验证输出：至少两条证据支持同一结论才写入主文本
4) 冲突时降级：写“倾向/可能”，不写“断言”

评分机制（建议）：
- `high`：几何测量 + 左右一致 + 视觉一致
- `medium`：几何或视觉单侧支持
- `low`：仅主观纹理观察

仅 `high/medium` 可进入 L1；`low` 仅在 L2/L3 作为补充描述。

---

## 4. 测量字典（建议扩展）

在现有五项基础上，新增以下字段（用于 coverage 提升）：

基础：
- 三停比例（上/中/下）
- 印堂宽度（及相对眼距）
- 田宅宫距离（及相对眼宽）
- 颧腮比（颧骨宽/下颌宽）
- 鼻翼宽度（相对眼距）

扩展：
- 面宽高比
- 双眼开合比（左右）
- 眉峰高低差
- 人中长度占脸高
- 口宽占眼距
- 下庭高度占脸高

发际线修正（重点）：
- 上庭起点由“额头点”改为“发际线估计点”；
- 在没有真实发丝分割时，先使用几何估计并在文案中显式标注“估计”。

---

## 5. Prompt 设计（可直接落地）

工程落地建议（已按此方向实施）：
- `server/prompt_templates/system_prompt.j2`
- `server/prompt_templates/deep_analysis_prompt.j2`
- `server/prompt_templates/parts/evidence_contract.txt`
- `server/prompt_templates/parts/face_reading_guideline.txt`

拼接顺序固定：`evidence_contract` 后接 `face_reading_guideline`，再进入任务模板，方便做 prompt caching。

### 5.1 L1 现场速览 Prompt（Grok）

系统指令模板（节选）：

```text
你是传统面相分析师，风格参考《麻衣神相》《水镜神相》的“相不独论”，但表达必须现代、克制、可执行。

你会收到：
1) 关键测量 JSON
2) 可视化轮廓图（不含真人像素）

写作规则：
- 只输出 JSON: {"face":"...","career":"...","blessing":"..."}
- 每条判断必须引用至少一个测量或可见特征
- 先证据、后结论：例如“印堂相对眼距=0.72，因此倾向开阔”
- 禁止绝对化词语：必须/注定/一定
- 结尾加入一句春节祝词
```

### 5.2 L2 扫码详版 Prompt（Gemini 3 Flash）

```text
角色：面相结构化分析师。
目标：输出一份 4 段式详细报告（五官与三停 / 事业财运 / 关系沟通 / 新春寄语）。

方法：
1) 先列证据（测量+轮廓）
2) 再做交叉验证（至少 2 个证据支撑）
3) 再给可执行建议（每段至少 1 条）

约束：
- 明确区分“确定性结论”与“倾向性结论”
- 如果证据不足，显式写“该项证据不足”
- 语言避免恐吓，保持鼓励和建设性
```

### 5.3 L3 邮件三模型 Prompt（DeepSeek / Grok / Gemini）

统一输入包，分别调用三模型，并要求输出统一结构：

```text
请按以下标题输出：
1. 证据摘要（结构化）
2. 三停与五官综合判断
3. 事业与决策建议（未来90天可执行）
4. 人际与情绪管理建议
5. 不确定性说明（证据不足项）
```

最后由聚合器生成：
- 共识结论（3 模型一致）
- 分歧结论（仅部分模型支持）
- 建议优先级（P1/P2/P3）

---

## 6. UI 文案与 CTA 规范（对应三层）

现场二维码旁文案：
- `扫码获取 Gemini 3 Flash 详细解读`

分享页邮箱 CTA：
- `留邮箱查看 DeepSeek、Grok、Gemini 三模型完整解读`

品牌/副标题滚动文案（动态轮播）：
- `Gemini AI · 深度结构化解读`
- `Grok AI · 直觉风格补充分析`
- `DeepSeek AI · 逻辑链路推断`

---

## 7. 数据契约（为 HTML 可视化与存储效率服务）

建议把“可视化事实”作为结构化数据持久化，而不是位图：

```json
{
  "landmarks": [[0.51,0.22], [0.52,0.23]],
  "contour_indices": {"face_oval":[10,338,...], "left_brow":[...]},
  "measurements": {"三停比例": {"上庭": 24, "中庭": 40, "下庭": 36}},
  "version": "v2",
  "generated_at": "2026-02-15T00:00:00Z"
}
```

前端用 SVG/Canvas 实时渲染。优势：
- 同等信息密度下，JSON 通常远小于 JPG；
- 可重绘、可交互、可二次计算；
- 便于后续模型复盘与 AB 测试。

---

## 8. 质量门禁（上线前）

最小验收：
- 同一输入重复生成，主结论稳定性 >= 90%
- 每条主结论能回溯到证据字段
- L1/L2/L3 不出现互相矛盾的核心判断
- 文案中包含“娱乐用途”轻提示

推荐评测集：
- 性别/年龄/光照/眼镜/遮挡多样样本
- 单独标注“耳部不可靠”样本用于降级验证

---

## 9. 引经据典口径（用于 prompt 背书）

建议在系统 prompt 中仅保留一句，避免“玄学感过重”：

`分析方法参考《麻衣神相》《水镜神相》的“相不独论”原则，并结合现代几何测量做交叉验证。`

这样既有出处，也明确是“传统经验 + 可计算证据”的混合路径。
