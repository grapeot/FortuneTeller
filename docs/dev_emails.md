# Email Deep Analysis + Community Subscription Flow

## Overview

When a user scans the QR code on the fortune result page and lands on the share page, they can enter their email to receive:
1. A detailed AI face reading analysis (longer, multi-angle, generated by Gemini)
2. Automatic membership in the Superlinear Academy Circle community

This document describes the end-to-end design.

## User Flow

```
Result page (kiosk)
  └─ QR code → user scans with phone
       └─ /share/{id} page (mobile browser)
            ├─ Displays: pixelated avatar + fortune (tabs: Grok / Gemini)
            └─ Email form at bottom:
                 ├─ Input: email address
                 ├─ Button: "接收 AI 深度面相分析"
                 ├─ Subtext (legal): see copy section below
                 └─ On submit:
                      ├─ Frontend: POST /api/subscribe {email, share_id}
                      ├─ Show: "分析已提交，结果将发送至您的邮箱"
                      └─ Backend (async):
                           ├─ 1. Circle: create member / add to spaces
                           ├─ 2. Gemini: generate deep analysis
                           └─ 3. Resend: send HTML email
```

## Frontend Changes

### SharePage.jsx

Add an email subscription form below the fortune content and above the "我也要相面" CTA:

- **Input**: `<input type="email" placeholder="your@email.com" />`
- **Button**: "接收 AI 深度面相分析"
- **Subtext**: "输入邮箱获取详细分析报告，并加入 Superlinear Academy AI 社区接收学员实战项目更新。社区邮件可随时退订。"
- **Post-submit state**: Replace form with confirmation: "分析已提交，结果将在数分钟内发送至您的邮箱。"
- **Validation**: basic email format check, disable button during submission
- **Error state**: "提交失败，请稍后重试" (with retry button)

### ResultOverlay.jsx

QR code label already changed to "扫码收藏" (done in Part A).

## Backend Changes

### New endpoint: `POST /api/subscribe`

**Request body:**
```json
{
  "email": "user@example.com",
  "share_id": "abc12345"
}
```

**Response (immediate):**
```json
{
  "status": "accepted",
  "message": "Analysis will be sent to your email"
}
```

The backend returns 200 immediately and processes the email pipeline in a background task (`asyncio.create_task` or `BackgroundTasks`).

### Background pipeline

#### Step 1: Circle membership

Using Circle Admin API v2:

```python
POST https://app.circle.so/api/admin/v2/community_members
Authorization: Token {CIRCLE_V2_TOKEN}
{
    "email": "...",
    "skip_invitation": true,
    "space_ids": [1391833, 1391825, 2231585],
    "email_notifications_enabled": true
}
```

- If 201 with "already a member": call `POST /api/admin/v2/space_members` for each space
- If 422: call space_members for each space
- 200/201 new member: spaces already included in creation request

The spaces have default notification level set to "All posts" in Circle admin, so the user automatically receives new post notifications.

#### Step 2: Gemini deep analysis

Call `gemini-3-flash-preview` via AI Builder Space API with an expanded prompt. Input data from Firestore (the share document):
- `pixelated_image` (not sent to AI, only for email display)
- `fortunes.grok` and `fortunes.gemini` (the quick results, for reference context)
- Original face image: **not stored** (privacy). The deep analysis uses the quick fortune results as a seed and expands on them.

**Deep analysis prompt** (system message): Same face reading knowledge base as the quick prompt, but with these differences:
- Output format: plain Chinese text (not JSON), structured with section headers
- Length: 1500-2000 characters (vs ~300 for the quick version)
- Sections: 五官详解, 三停分析, 十二宫位, 事业与发展, 人际与感情, 健康提示, 马年运势综述
- Tone: More literary, like a written report vs a spoken quick reading
- Input: the quick fortune text (from both models) as context

#### Step 3: Send email via Resend

```python
resend.Emails.send({
    "from": "Superlinear Academy <no-reply@ai-builders.com>",
    "to": [email],
    "subject": "您的AI面相深度分析 - Superlinear Academy",
    "html": rendered_html
})
```

**Email template** (HTML):
- Dark background (#0f0f23) matching the app
- Gold (#facc15) headings, white body text
- Sections matching the deep analysis output
- Pixelated avatar displayed at top (as inline base64 or hosted URL)
- CTA button: "加入 AI Builder 社区" → invitation link from Circle
- Footer: "此邮件由 Superlinear Academy 发送。社区动态邮件可随时在设置中退订。"

#### Invitation link

Fetched via `GET /api/admin/v2/invitation_links?status=active&per_page=1`. Cached server-side (TTL 1h). Fallback: `https://www.superlinear.academy`.

## Firestore Data

The existing `fortunes` collection document gains an optional field:

```json
{
  "pixelated_image": "data:image/png;base64,...",
  "fortunes": { "gemini": {...}, "grok": {...} },
  "created_at": "...",
  "subscribed_email": "user@example.com",     // NEW: set by /api/subscribe
  "email_sent_at": "..."                       // NEW: set after Resend success
}
```

## Frontend Copy

### Form (before submit)
- **Button text**: 接收 AI 深度面相分析
- **Subtext**: 输入邮箱获取详细分析报告，并加入 Superlinear Academy AI 社区接收学员实战项目更新。社区邮件可随时退订。

### After submit
- **Message**: 分析已提交，结果将在数分钟内发送至您的邮箱。与此同时，您也会收到社区学员分享的项目更新。

## Legal / Compliance Notes

- No "marketing materials" checkbox. The email subscription is framed as part of the service ("receive your detailed analysis report + community updates").
- The subtext makes clear that community emails can be unsubscribed at any time.
- Circle natively includes unsubscribe links in all notification emails.
- The Resend email includes a footer with sender identity (Superlinear Academy) per CAN-SPAM requirements.
- Original face image is never stored; only the pixelated avatar and fortune text are persisted.

## Environment Variables

All already present in `.env`:

| Variable | Purpose |
|---|---|
| `AI_BUILDER_TOKEN` | AI Builder Space API (Gemini calls) |
| `RESEND_API_KEY` | Resend email sending |
| `CIRCLE_V2_TOKEN` | Circle Admin API v2 |
| `CIRCLE_SPACE_IDS` | Comma-separated space IDs |
| `FIREBASE_CREDENTIALS` | Firestore access |

For deployment, these need to be injected as environment variables in the AI Builder Space deployment config.

## New Dependencies

Add to `requirements.txt`:
- `resend` (email sending)
- `requests` (Circle API; or continue using `httpx` for consistency)

## Implementation Order

1. **Backend**: Add `POST /api/subscribe` endpoint to `server.py`
2. **Backend**: Implement background task (Circle + Gemini + Resend)
3. **Backend**: Create HTML email template renderer
4. **Frontend**: Add email form to `SharePage.jsx`
5. **Test**: End-to-end with real email
6. **Deploy**: Add `resend` to requirements.txt, rebuild Docker, push

## Validated Pipeline

The standalone script `scripts/test_circle_flow.py` has already validated:
- Circle member creation with `skip_invitation: true` works (returns 201)
- Adding existing members to spaces works (422 = already in space = success)
- Active invitation links can be fetched via API
- Resend email delivery works from `no-reply@ai-builders.com`
